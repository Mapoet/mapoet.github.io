name: æ©æ˜Ÿé¢„æŠ¥æ•°æ®æ›´æ–°

on:
  schedule:
    - cron: "*/5 * * * *"  # æ¯éš”ä¸¤å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - scripts/occultation_predict.py
      - assets/traj/Rx-YY_*.tle
      - requirements.txt

jobs:
  occultation-predict:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # è®¾ç½®è¶…æ—¶æ—¶é—´
    
    steps:
      - name: æ‹‰å–ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºæäº¤

      - name: è®¾ç½® Python 
        uses: actions/setup-python@v5
        with:
          python-version: 3.14.0-beta.4

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          echo "å¼€å§‹å®‰è£…ç³»ç»Ÿä¾èµ–..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            gcc \
            g++ \
            libproj-dev \
            proj-data \
            proj-bin \
            build-essential \
            libopenblas-dev \
            liblapack-dev
          echo "ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

      - name: å®‰è£… Python ä¾èµ–
        run: |
          echo "å¼€å§‹å®‰è£… Python ä¾èµ–..."
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
          echo "Python ä¾èµ–å®‰è£…å®Œæˆ"
          echo "å·²å®‰è£…çš„åŒ…:"
          pip list | grep -E "(numpy|sgp4|pyproj|scipy|astropy)"

      - name: æ£€æŸ¥è¾“å…¥æ–‡ä»¶
        run: |
          echo "æ£€æŸ¥è¾“å…¥æ–‡ä»¶..."
          if [ -f "scripts/occultation_predict.py" ]; then
            echo "âœ“ æ‰¾åˆ° occultation_predict.py"
          else
            echo "âœ— æœªæ‰¾åˆ° occultation_predict.py"
            exit 1
          fi
          
          if ls scripts/Rx-YY_*.tle 1> /dev/null 2>&1; then
            echo "âœ“ æ‰¾åˆ° TLE æ–‡ä»¶:"
            ls -la scripts/Rx-YY_*.tle
          else
            echo "âœ— æœªæ‰¾åˆ° TLE æ–‡ä»¶"
            exit 1
          fi

      - name: è¿è¡Œæ©æ˜Ÿé¢„æŠ¥è„šæœ¬
        run: |
          echo "å¼€å§‹è¿è¡Œæ©æ˜Ÿé¢„æŠ¥è„šæœ¬..."
          cd scripts
          python occultation_predict.py
          echo "æ©æ˜Ÿé¢„æŠ¥è„šæœ¬æ‰§è¡Œå®Œæˆ"

      - name: æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
        run: |
          echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
          if [ -f "assets/traj/occultation_events.json" ]; then
            echo "âœ“ æ©æ˜Ÿäº‹ä»¶æ–‡ä»¶å·²ç”Ÿæˆ"
            echo "æ–‡ä»¶å¤§å°: $(wc -l < assets/traj/occultation_events.json) è¡Œ"
            echo "æ–‡ä»¶å¤§å°: $(du -h assets/traj/occultation_events.json | cut -f1)"
          else
            echo "âœ— æ©æ˜Ÿäº‹ä»¶æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          
          if [ -f "assets/traj/satellite_orbits.json" ]; then
            echo "âœ“ å«æ˜Ÿè½¨é“æ–‡ä»¶å·²ç”Ÿæˆ"
            echo "æ–‡ä»¶å¤§å°: $(wc -l < assets/traj/satellite_orbits.json) è¡Œ"
            echo "æ–‡ä»¶å¤§å°: $(du -h assets/traj/satellite_orbits.json | cut -f1)"
          else
            echo "âœ— å«æ˜Ÿè½¨é“æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          
          echo "æ‰€æœ‰è¾“å‡ºæ–‡ä»¶æ£€æŸ¥å®Œæˆ"

      - name: éªŒè¯ JSON æ ¼å¼
        run: |
          echo "éªŒè¯ JSON æ–‡ä»¶æ ¼å¼..."
          python -m json.tool assets/traj/occultation_events.json > /dev/null && echo "âœ“ æ©æ˜Ÿäº‹ä»¶ JSON æ ¼å¼æ­£ç¡®" || (echo "âœ— æ©æ˜Ÿäº‹ä»¶ JSON æ ¼å¼é”™è¯¯" && exit 1)
          python -m json.tool assets/traj/satellite_orbits.json > /dev/null && echo "âœ“ å«æ˜Ÿè½¨é“ JSON æ ¼å¼æ­£ç¡®" || (echo "âœ— å«æ˜Ÿè½¨é“ JSON æ ¼å¼é”™è¯¯" && exit 1)
          echo "JSON æ ¼å¼éªŒè¯å®Œæˆ"

      - name: é…ç½® Git
        run: |
          echo "é…ç½® Git ç”¨æˆ·ä¿¡æ¯..."
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: æäº¤æ›´æ–°
        run: |
          echo "å‡†å¤‡æäº¤æ›´æ–°..."
          git add assets/traj/occultation_events.json
          git add assets/traj/satellite_orbits.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–°çš„å˜æ›´éœ€è¦æäº¤"
          else
            echo "æäº¤å˜æ›´..."
            git commit -m "ğŸ¤– Auto update occultation data $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo "æ¨é€å˜æ›´..."
            git push
            echo "âœ“ å˜æ›´å·²æˆåŠŸæäº¤å’Œæ¨é€"
          fi

      - name: æ˜¾ç¤ºæ›´æ–°çŠ¶æ€
        run: |
          echo "=========================================="
          echo "ğŸ‰ æ©æ˜Ÿé¢„æŠ¥æ•°æ®æ›´æ–°å®Œæˆ"
          echo "=========================================="
          echo "æ›´æ–°æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ç”Ÿæˆæ–‡ä»¶:"
          ls -la assets/traj/
          echo "==========================================" 
---
title: "全球天气查询与可视化"
date: 2014-03-12
permalink: /posts/2024/03/blog-post-2
excerpt: '全球天气查询与可视化'
tags:
    - Weather
    - Atmosphere
---

  <div>
    <h1>全球天气查询</h1>
    <div>
      <input type="text" id="locationInput" placeholder="请输入地点">
      <button id="weatherBtn">查询</button>
    </div>
    <p id="locationName"></p>
    <div>
      <div id="temp-c"></div>
      <div id="temp-f"></div>
      <div id="temp-chart"></div>
    </div>
    <div id="humidity-chart"></div>
    <div id="windspeed-chart"></div>
    <div id="pressure-chart"></div>
  </div>
  {% raw %}
  <script src="https://cdn.jsdelivr.net/npm/d3@4.13.0/build/d3.min.js"></script>
  <script>
    // 温度转换函数
    function toCelsius(kelvin) { 
      return kelvin - 273.15; 
    }
    function toFahrenheit(kelvin) { 
      return toCelsius(kelvin) * 9/5 + 32; 
    }
    // 风速转换：m/s 转 km/h
    function mpsToKmph(mps) {
      return mps * 3.6;
    }
    
    // 新增城市映射，包含中国所有知名城市（各省会及宝鸡类型及以上）
    function translateAndDetect(location, callback) {
      const mapping = {
        // 各省会和重点城市（中国）
        "北京": "Beijing, CN",
        "天津": "Tianjin, CN",
        "上海": "Shanghai, CN",
        "重庆": "Chongqing, CN",
        "哈尔滨": "Harbin, CN",
        "长春": "Changchun, CN",
        "沈阳": "Shenyang, CN",
        "呼和浩特": "Hohhot, CN",
        "石家庄": "Shijiazhuang, CN",
        "太原": "Taiyuan, CN",
        "西安": "Xi'an, CN",
        "济南": "Jinan, CN",
        "郑州": "Zhengzhou, CN",
        "南京": "Nanjing, CN",
        "合肥": "Hefei, CN",
        "杭州": "Hangzhou, CN",
        "福州": "Fuzhou, CN",
        "南昌": "Nanchang, CN",
        "武汉": "Wuhan, CN",
        "长沙": "Changsha, CN",
        "广州": "Guangzhou, CN",
        "南宁": "Nanning, CN",
        "海口": "Haikou, CN",
        "成都": "Chengdu, CN",
        "贵阳": "Guiyang, CN",
        "昆明": "Kunming, CN",
        "拉萨": "Lhasa, CN",
        "西宁": "Xining, CN",
        // 其他较知名城市
        "宝鸡": "Baoji, CN",
        "苏州": "Suzhou, CN",
        "温州": "Wenzhou, CN",
        "宁波": "Ningbo, CN",
        "徐州": "Xuzhou, CN",
        "常州": "Changzhou, CN",
        "无锡": "Wuxi, CN",
        "郑州": "Zhengzhou, CN",
        // 国际城市
        "纽约": "New York, US",
        "洛杉矶": "Los Angeles, US",
        "芝加哥": "Chicago, US",
        "伦敦": "London, UK",
        "巴黎": "Paris, FR",
        "罗马": "Rome, IT",
        "东京": "Tokyo, JP",
        "首尔": "Seoul, KR",
        "悉尼": "Sydney, AU",
        "新加坡": "Singapore, SG"
      };
      if (mapping[location]) {
        callback(mapping[location]);
      } else {
        // 默认认为用户输入为英文或其它合适格式
        callback(location);
      }
    }
    
    // 清空已有图形，防止重复绘制
    function clearCharts() {
      d3.select("#humidity-chart").selectAll("*").remove();
      d3.select("#windspeed-chart").selectAll("*").remove();
      d3.select("#pressure-chart").selectAll("*").remove();
      d3.select("#temp-chart").selectAll("*").remove();
    }
    
    // 绘制温度计图形（以摄氏温度为基础显示）
    // 设定范围 -20°C ~ 50°C，共70度范围，使用垂直条展示实际温度
    function drawTemperatureGauge(celsius) {
      const width = 60, height = 300;
      const minTemp = -50, maxTemp = 60;
      const tempRange = maxTemp - minTemp;
      const svg = d3.select("#temp-chart")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height);
      
      // 绘制背景色（温度计外部背景）
      svg.append("rect")
         .attr("x", width/4)
         .attr("y", 0)
         .attr("width", width/2)
         .attr("height", height)
         .attr("fill", "#ddd")
         .attr("rx", width/4);
      
      // 计算实际填充比例（clamp在温度范围内）
      var clamped = Math.max(minTemp, Math.min(celsius, maxTemp));
      var fillPercent = (clamped - minTemp) / tempRange;
      var fillHeight = height * fillPercent;
      
      // 使用渐变色显示温度，红色越深代表温度越高
      var gradient = svg.append("defs")
                        .append("linearGradient")
                        .attr("id", "temp-gradient")
                        .attr("x1", "0%")
                        .attr("x2", "0%")
                        .attr("y1", "100%")
                        .attr("y2", "0%");
      gradient.append("stop")
              .attr("offset", "0%")
              .attr("stop-color", "#2196F3"); // 冷色调蓝色
      gradient.append("stop")
              .attr("offset", "100%")
              .attr("stop-color", "#FF5722"); // 暖色调橙红
      
      // 绘制温度填充条，从底部向上填充
      svg.append("rect")
         .attr("x", width/4)
         .attr("y", height - fillHeight)
         .attr("width", width/2)
         .attr("height", fillHeight)
         .attr("fill", "url(#temp-gradient)")
         .attr("rx", width/4);
      
      // 在温度计旁边显示具体温度值
      svg.append("text")
         .attr("x", width/2)
         .attr("y", height - fillHeight - 10)
         .attr("text-anchor", "middle")
         .attr("fill", "#333")
         .style("font-size", "14px")
         .text(celsius + "°C");
    }
    
    // 绘制湿度圆盘（显示 0～100% 的湿度，每个刻度代表1%）
    function drawHumidityGauge(humidity) {
      const width = 200, height = 200;
      const outerRadius = Math.min(width, height) / 2;
      const innerRadius = outerRadius - 15;
      const numTicks = 100;
      
      const svg = d3.select("#humidity-chart")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", `translate(${width/2},${height/2})`);
      
      const tickAngle = 2 * Math.PI / numTicks;
      
      for (let i = 0; i < numTicks; i++) {
        svg.append("path")
          .attr("d", d3.arc()
              .innerRadius(innerRadius)
              .outerRadius(outerRadius)
              .startAngle(i * tickAngle)
              .endAngle((i + 1) * tickAngle))
          .attr("fill", i < humidity ? "#4CAF50" : "#ddd");
      }
      
      svg.append("text")
         .attr("text-anchor", "middle")
         .attr("dy", "0.3em")
         .style("font-size", "1.5em")
         .text(humidity + "%");
      
      d3.select("#humidity-chart")
        .append("div")
        .attr("class", "chart-label")
        .text("相对湿度");
    }
    
    // 绘制风速进度条（转换为 km/h，假设最大 100 km/h）
    function drawWindSpeedGauge(windSpeedKmph) {
      const width = 300, height = 20;
      const maxWind = 100;
      
      const svg = d3.select("#windspeed-chart")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height);
      
      svg.append("rect")
         .attr("x", 0)
         .attr("y", 0)
         .attr("width", width)
         .attr("height", height)
         .attr("fill", "#ddd")
         .attr("rx", 10);
      
      svg.append("rect")
         .attr("x", 0)
         .attr("y", 0)
         .attr("width", Math.min(width, width * windSpeedKmph / maxWind))
         .attr("height", height)
         .attr("fill", "#2196F3")
         .attr("rx", 10);
      
      d3.select("#windspeed-chart")
         .append("div")
         .attr("class", "chart-label")
         .text("风速：" + windSpeedKmph.toFixed(2) + " km/h");
    }
    
    // 绘制气压进度条（假设范围 900～1100 hPa）
    function drawPressureGauge(pressure) {
      const width = 300, height = 20;
      const minPressure = 900, maxPressure = 1100;
      
      const svg = d3.select("#pressure-chart")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height);
      
      svg.append("rect")
         .attr("x", 0)
         .attr("y", 0)
         .attr("width", width)
         .attr("height", height)
         .attr("fill", "#ddd")
         .attr("rx", 10);
      
      const clamped = Math.max(minPressure, Math.min(pressure, maxPressure));
      const widthPressure = width * ((clamped - minPressure) / (maxPressure - minPressure));
      
      svg.append("rect")
         .attr("x", 0)
         .attr("y", 0)
         .attr("width", widthPressure)
         .attr("height", height)
         .attr("fill", "#FF9800")
         .attr("rx", 10);
      
      d3.select("#pressure-chart")
         .append("div")
         .attr("class", "chart-label")
         .text("气压：" + pressure + " hPa");
    }
    
    // 主函数：请求天气数据并更新页面显示
    function getWeather(){
      var userInput = document.getElementById("locationInput").value.trim();
      if (!userInput){
        alert("请输入地点！");
        return;
      }
      clearCharts();
      translateAndDetect(userInput, function(locationEnglish){
        document.getElementById("locationName").innerText = "查询地点：" + locationEnglish;
        var url = "https://api.openweathermap.org/data/2.5/weather?q="
                  + encodeURIComponent(locationEnglish)
                  + "&appid=a3d9b50b2022aaff3f6b7eb24288e5c8";
        d3.json(url, function(error, data) {
          if (error || !data || data.cod !== 200) {
            document.getElementById("temp-c").innerText = "";
            document.getElementById("temp-f").innerText = "";
            alert("无法获取天气数据，请检查地点是否正确。");
            return;
          }
          // 温度数据处理
          var kelvin = data.main.temp;
          var celsius = toCelsius(kelvin).toFixed(2);
          var fahrenheit = toFahrenheit(kelvin).toFixed(2);
          document.getElementById("temp-c").innerText = "摄氏温度：" + celsius + " °C";
          document.getElementById("temp-f").innerText = "华氏温度：" + fahrenheit + " °F";
          
          // 绘制温度计图形
          drawTemperatureGauge(parseFloat(celsius));
          
          // 其他气象要素
          var humidity = data.main.humidity;    // 相对湿度
          var windSpeed = data.wind.speed;        // m/s
          var windSpeedKmph = mpsToKmph(windSpeed); // km/h
          var pressure = data.main.pressure;      // hPa
          
          drawHumidityGauge(humidity);
          drawWindSpeedGauge(windSpeedKmph);
          drawPressureGauge(pressure);
        });
      });
    }
    // 事件绑定，确保主题包裹下也能正常工作
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('weatherBtn').addEventListener('click', getWeather);
    });
  </script>
{% endraw %}

